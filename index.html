<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ€»è£é™†ç‘¶ï¼šè¡—å¤´é‡é€¢ (åƒç´ RPGç‰ˆ)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');

        :root {
            --bg-color: #202020;
            --dialog-bg: #2d5a7d; /* å®å¯æ¢¦é£æ ¼è“æ¡† */
            --dialog-border: #ffffff;
            --text-color: #ffffff;
            --accent-color: #f1c40f;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: manipulation; }

        body {
            background-color: var(--bg-color);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'VT323', 'Courier New', monospace; /* åƒç´ å­—ä½“ */
            overflow: hidden;
        }

        /* æ¸¸æˆæœºå¤–å£³ */
        #gameboy {
            width: 100%;
            max-width: 600px;
            height: 100vh;
            max-height: 800px;
            background: #000;
            position: relative;
            display: flex;
            flex-direction: column;
            border: 2px solid #444;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        /* 1. æ¸¸æˆç”»é¢åŒºåŸŸ (Canvas) */
        #screen-container {
            flex: 1; /* å æ®ä¸ŠåŠéƒ¨åˆ† */
            position: relative;
            background: #369a49; /* è‰åœ°ç»¿/åœ°é¢è‰² */
            overflow: hidden;
            image-rendering: pixelated; /* å¼ºåˆ¶åƒç´ åŒ– */
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* é™éŸ³æŒ‰é’® */
        #mute-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            background: rgba(0,0,0,0.6);
            border: 2px solid #fff;
            color: #fff;
            font-family: inherit;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 16px;
        }

        /* 2. å¯¹è¯æ¡†ä¸æ“ä½œåŒº (ä¸‹æ–¹) */
        #dialog-box {
            height: 40%; /* å æ®ä¸‹åŠéƒ¨åˆ† */
            background: var(--dialog-bg);
            border-top: 6px solid #e0e0e0;
            border-bottom: 6px solid #e0e0e0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            color: white;
            font-size: 20px;
            box-shadow: inset 0 0 0 4px #1a3b52;
            position: relative;
            z-index: 100; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
        }

        /* è£…é¥°æ€§è¾¹æ¡†è§’ */
        #dialog-box::before {
            content: ''; position: absolute; top: -6px; left: 0; width: 100%; height: 6px; background: #a0a0a0;
        }

        /* æ–‡æœ¬åŒºåŸŸ */
        #text-content {
            flex: 1;
            line-height: 1.6;
            margin-bottom: 15px;
            text-shadow: 2px 2px 0px #000;
            overflow-y: auto;
        }
        
        .name-tag {
            color: var(--accent-color);
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
            font-size: 1.2em;
        }

        /* é€‰é¡¹æŒ‰é’®åŒºåŸŸ */
        #options-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        button.option-btn {
            background: #fff;
            border: 4px solid #000; /* åƒç´ é£æ ¼è¾¹æ¡† */
            color: #000;
            padding: 12px;
            font-family: inherit;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            text-align: left;
            position: relative;
            transition: transform 0.1s;
        }

        button.option-btn:hover {
            background: var(--accent-color);
            transform: translateY(-2px);
        }
        
        button.option-btn:active {
            transform: translateY(2px);
        }

        /* æŒ‡é’ˆå›¾æ ‡ */
        button.option-btn::before {
            content: 'â–¶';
            margin-right: 10px;
            color: #d32f2f;
            opacity: 0;
        }
        button.option-btn:hover::before {
            opacity: 1;
        }

        /* é®ç½©å±‚ */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: #fff;
            text-align: center;
        }
        #start-btn {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 24px;
            font-family: inherit;
            background: var(--accent-color);
            border: 4px solid #fff;
            cursor: pointer;
            color: #000;
            animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0.5; } }

    </style>
</head>
<body>

<div id="gameboy">
    <div id="screen-container">
        <canvas id="gameCanvas"></canvas>
        <button id="mute-btn">ğŸ”‡ å¼€å¯éŸ³ä¹</button>
    </div>

    <div id="dialog-box">
        <div id="text-content">
            </div>
        <div id="options-container">
            </div>
    </div>

    <div id="overlay">
        <h1 style="font-size: 40px; color: var(--accent-color); text-shadow: 4px 4px 0 #000; margin-bottom: 20px;">è¡—å¤´é‡é€¢</h1>
        <p>RPG åƒç´ ç‰ˆ</p>
        <button id="start-btn">å¼€å§‹æ¸¸æˆ</button>
    </div>
</div>

<script>
/**
 * =========================================
 * 1. åƒç´ ç”»ç»˜åˆ¶å¼•æ“ (Canvas)
 * =========================================
 */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
// ç¦ç”¨å¹³æ»‘å¤„ç†ï¼Œä¿æŒåƒç´ é£é”¯é½¿æ„Ÿ
ctx.imageSmoothingEnabled = false; 

let width, height;
// æ¯ä¸€å¸§çš„è®¡æ•°å™¨ï¼Œç”¨äºåŠ¨ç”»
let frameCount = 0; 

// å®šä¹‰åƒç´ å›¾é…è‰²
const C = {
    _: null, // é€æ˜
    S: '#fceada', // è‚¤è‰² (Skin)
    H: '#3e2723', // å¤´å‘ (Hair)
    BL: '#1a237e', // è¥¿è£…è“ (Blue)
    GD: '#ffd700', // é‡‘è‰² (Gold)
    GR: '#546e7a', // å«è¡£ç° (Gray)
    DK: '#263238', // æ·±è‰²é˜´å½±
    WT: '#ffffff', // ç™½
    PK: '#f48fb1'  // è…®çº¢
};

// åƒç´ ç”»æ•°æ® (12x12 ç½‘æ ¼)
// é™†ç‘¶ï¼šå¾®èƒ–ã€æ¼‚äº®ã€è¥¿è£…ã€çš‡å† 
const spriteLuYao = [
    [C._,C._,C._,C.GD,C.GD,C.GD,C.GD,C._,C._,C._,C._,C._], // çš‡å† 
    [C._,C._,C.GD,C.H,C.H,C.H,C.H,C.GD,C._,C._,C._,C._],
    [C._,C.H,C.H,C.H,C.H,C.H,C.H,C.H,C.H,C._,C._,C._],
    [C._,C.H,C.H,C.S,C.S,C.S,C.S,C.H,C.H,C._,C._,C._],
    [C._,C._,C.S,C.S,C.PK,C.S,C.PK,C.S,C._,C._,C._,C._], // è„¸ (å¸¦è…®çº¢)
    [C._,C._,C.S,C.S,C.S,C.S,C.S,C.S,C._,C._,C._,C._],
    [C._,C.BL,C.BL,C.WT,C.WT,C.WT,C.WT,C.BL,C.BL,C._,C._,C._], // è¥¿è£…é¢†å£
    [C._,C.BL,C.BL,C.BL,C.BL,C.BL,C.BL,C.BL,C.BL,C._,C._,C._], // èº«ä½“ (å¾®èƒ–åœ†æ¶¦)
    [C._,C.BL,C.BL,C.GD,C.GD,C.GD,C.GD,C.BL,C.BL,C._,C._,C._], // é‡‘æ‰£å­
    [C._,C.BL,C.BL,C.BL,C.BL,C.BL,C.BL,C.BL,C.BL,C._,C._,C._],
    [C._,C._,C.S,C._,C._,C._,C._,C.S,C._,C._,C._,C._], // æ‰‹
    [C._,C._,C.BL,C._,C._,C._,C._,C.BL,C._,C._,C._,C._]  // è…¿
];

// ç½—æ»•ï¼šèƒ–ã€ä¸‘ã€å«è¡£ã€æµæ±—
const spriteLuoTeng = [
    [C._,C._,C._,C.GR,C.GR,C.GR,C.GR,C._,C._,C._,C._,C._], // å«è¡£å¸½
    [C._,C._,C.GR,C.H,C.H,C.H,C.H,C.GR,C._,C._,C._,C._],
    [C._,C.GR,C.H,C.S,C.S,C.S,C.S,C.H,C.GR,C._,C._,C._],
    [C._,C.GR,C.S,C.WT,C.S,C.S,C.WT,C.S,C.GR,C._,C._,C._], // çœ¼ç›å°
    [C._,C.GR,C.S,C.S,C.S,C.S,C.S,C.S,C.GR,C._,C._,C._], // è„¸å¾ˆå¤§
    [C._,C._,C.S,C.S,C.DK,C.DK,C.S,C.S,C._,C._,C._,C._], // å˜´å·´
    [C._,C.GR,C.GR,C.GR,C.GR,C.GR,C.GR,C.GR,C.GR,C._,C._,C._], // èº«ä½“ (å¾ˆå®½)
    [C.GR,C.GR,C.GR,C.GR,C.GR,C.GR,C.GR,C.GR,C.GR,C.GR,C._,C._], 
    [C.GR,C.GR,C.GR,C.GR,C.GR,C.GR,C.GR,C.GR,C.GR,C.GR,C._,C._],
    [C._,C.S,C.GR,C.GR,C.GR,C.GR,C.GR,C.GR,C.S,C._,C._,C._], // æ‰‹æ’‘åœ°
    [C._,C._,C.DK,C.DK,C._,C._,C.DK,C.DK,C._,C._,C._,C._], // è†ç›–è·ªç€
    [C._,C._,C._,C._,C._,C._,C._,C._,C._,C._,C._,C._]
];

// ç»˜åˆ¶ä¸€ä¸ªåƒç´ å—
function drawSprite(ctx, sprite, startX, startY, scale, bounce) {
    const yOffset = bounce ? Math.sin(frameCount * 0.1) * 2 : 0;
    
    for (let y = 0; y < sprite.length; y++) {
        for (let x = 0; x < sprite[y].length; x++) {
            if (sprite[y][x]) {
                ctx.fillStyle = sprite[y][x];
                ctx.fillRect(
                    startX + x * scale, 
                    startY + y * scale + yOffset, 
                    scale, scale
                );
            }
        }
    }
}

// ç»˜åˆ¶èƒŒæ™¯ (ç®€å•çš„ç“·ç –åœ°å’Œè¿œæ™¯)
function drawBackground() {
    // 1. åœ°é¢ (æ–¹æ ¼)
    ctx.fillStyle = '#2c3e50'; // æ·±è‰²æ²¥é’/åœ°æ¯¯
    ctx.fillRect(0, 0, width, height);
    
    // ç»˜åˆ¶ä¸€äº›åœ°ç –çº¹ç†
    ctx.strokeStyle = '#34495e';
    ctx.lineWidth = 2;
    const tileSize = 40;
    for(let x=0; x<width; x+=tileSize) {
        ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, height); ctx.stroke();
    }
    for(let y=0; y<height; y+=tileSize) {
        ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(width, y); ctx.stroke();
    }

    // 2. çº¢åœ°æ¯¯ (å› ä¸ºä½ æ˜¯æ€»è£)
    ctx.fillStyle = '#7f0000';
    ctx.fillRect(width/2 - 60, 0, 120, height);
    ctx.strokeStyle = '#ffb300'; // é‡‘è¾¹
    ctx.strokeRect(width/2 - 60, 0, 120, height);

    // 3. èšå…‰ç¯æ•ˆæœ
    const gradient = ctx.createRadialGradient(width/2, height/2, 50, width/2, height/2, 300);
    gradient.addColorStop(0, 'rgba(255, 255, 255, 0.1)');
    gradient.addColorStop(1, 'rgba(0, 0, 0, 0.6)');
    ctx.fillStyle = gradient;
    ctx.fillRect(0,0,width,height);
}

// æ¸²æŸ“ä¸»å¾ªç¯
function render() {
    width = canvas.width = document.getElementById('screen-container').clientWidth;
    height = canvas.height = document.getElementById('screen-container').clientHeight;
    
    ctx.clearRect(0, 0, width, height);
    
    drawBackground();

    const scale = 8; // åƒç´ æ”¾å¤§å€æ•°
    const centerX = width / 2;
    const centerY = height / 2;

    // ç»˜åˆ¶ç½—æ»• (ä¸Šæ–¹ï¼Œè·ªç€ï¼ŒèƒŒå¯¹æˆ–è€…ä¾§èº«)
    // æ ¹æ®çŠ¶æ€æ”¹å˜ç½—æ»•çš„ä½ç½®
    let ltY = centerY - 100;
    if (gameState.luotengStatus === 'gone') {
        // ä¸ç»˜åˆ¶
    } else {
        // ç½—æ»•åœ¨çº¢æ¯¯ä¸Š
        drawSprite(ctx, spriteLuoTeng, centerX - (12*scale)/2, ltY, scale, false);
        
        // ç»˜åˆ¶æ±—æ°´ (ç®€å•åŠ¨ç”»)
        if (gameState.luotengStatus === 'scared' && frameCount % 20 < 10) {
            ctx.fillStyle = '#00ffff';
            ctx.fillRect(centerX + 30, ltY + 20, scale, scale*2); // ä¸€æ»´æ±—
        }
    }

    // ç»˜åˆ¶é™†ç‘¶ (ä¸‹æ–¹ï¼ŒèƒŒå¯¹ç©å®¶ -> é¢å‘ç½—æ»•)
    // æˆ‘ä»¬ç”¨åŒä¸€ä¸ª spriteï¼Œä½†åœ¨ RPG é‡Œé€šå¸¸ä¸»è§’åœ¨ä¸‹æ–¹æ˜¯èƒŒé¢ï¼Œè¿™é‡Œä¸ºäº†å±•ç¤ºå½¢è±¡ï¼Œæˆ‘ä»¬å‡è®¾æ˜¯ä¿¯è§†è§’ä¾§é¢
    drawSprite(ctx, spriteLuYao, centerX - (12*scale)/2, centerY + 20, scale, true);

    // ç»˜åˆ¶å¯¹è¯æ°”æ³¡ (å¦‚æœæœ‰äººè¯´è¯)
    // ç®€åŒ–ä¸ºä»…åœ¨ä¸‹æ–¹æ–‡æœ¬æ¡†æ˜¾ç¤º

    frameCount++;
    requestAnimationFrame(render);
}

/**
 * =========================================
 * 2. éŸ³é¢‘ç³»ç»Ÿ (Web Audio API - é’¢ç´ + éŸ³æ•ˆ)
 * =========================================
 */
const AudioSys = {
    ctx: null, isMuted: true,
    init: function() {
        if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        if (this.ctx.state === 'suspended') this.ctx.resume();
    },
    // æ’­æ”¾ç®€å•çš„ 8-bit é£æ ¼é’¢ç´éŸ³ç¬¦
    playTone: function(freq, duration = 0.5) {
        if (this.isMuted) return;
        this.init();
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        
        osc.type = 'square'; // 8-bit é£æ ¼æ³¢å½¢
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        
        gain.gain.setValueAtTime(0.05, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
        
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    },
    // æ’­æ”¾ç‚¹å‡»/æ‰“å­—éŸ³æ•ˆ
    playBlip: function() {
        if (this.isMuted) return;
        this.playTone(800, 0.1);
    },
    // æ’­æ”¾æ‚²ä¼¤/å¿§éƒçš„æ—‹å¾‹ (å¾ªç¯)
    playMusic: function() {
        if (this.isMuted) return;
        // ç®€å•çš„ç¶éŸ³å¾ªç¯
        const notes = [220, 261, 329, 261, 196, 246, 293, 246]; // Am - G
        let i = 0;
        if (this.interval) clearInterval(this.interval);
        this.interval = setInterval(() => {
            if(!this.isMuted) this.playTone(notes[i], 0.6);
            i = (i + 1) % notes.length;
        }, 600);
    },
    stopMusic: function() {
        if (this.interval) clearInterval(this.interval);
    },
    toggleMute: function() {
        this.isMuted = !this.isMuted;
        const btn = document.getElementById('mute-btn');
        if (this.isMuted) {
            this.stopMusic();
            btn.innerText = "ğŸ”‡ å¼€å¯éŸ³ä¹";
        } else {
            this.playMusic();
            btn.innerText = "ğŸ”Š å…³é—­éŸ³ä¹";
        }
    }
};

/**
 * =========================================
 * 3. æ¸¸æˆå‰§æƒ…ä¸é€»è¾‘
 * =========================================
 */
const scenes = {
    'intro': {
        name: 'ç³»ç»Ÿæ—ç™½',
        text: 'è¿™æ˜¯é›†å›¢å¹´åº¦ç››å…¸çš„çº¢æ¯¯ç°åœºã€‚\nä½ ï¼Œé™†ç‘¶ï¼Œç™¾äº¿å¥³æ€»è£ï¼Œæ­£äº«å—ç€é—ªå…‰ç¯çš„æ´—ç¤¼ã€‚\nçªç„¶ï¼Œä¸€ä¸ªå·¨å¤§çš„èº«å½±å†²ç ´ä¿å®‰é˜²çº¿ï¼Œè·ªåœ¨äº†ä½ é¢å‰...',
        luoteng: 'normal',
        choices: [
            { text: 'ä»–æ˜¯è°ï¼Ÿä»”ç»†çœ‹çœ‹', next: 'identify' }
        ]
    },
    'identify': {
        name: 'é™†ç‘¶ (æˆ‘)',
        text: 'æˆ‘çœ‹æ¸…äº†ã€‚è¿™å›¢åˆè„åˆè‡­çš„è‚¥è‚‰ï¼Œç«Ÿç„¶æ˜¯ç½—æ»•ã€‚\né‚£ä¸ªäº”å¹´å‰å·èµ°æˆ‘æ•‘å‘½é’±è·‘è·¯çš„å‰ç”·å‹ã€‚\nä»–ç°åœ¨åªæœ‰19å²ï¼Œå´èƒ–å¾—åƒä¸ªå……æ°”çƒã€‚',
        luoteng: 'normal',
        choices: [
            { text: 'å†·ç¬‘ï¼Œå¬å¬ä»–æƒ³è¯´ä»€ä¹ˆ', next: 'dialog1' }
        ]
    },
    'dialog1': {
        name: 'ç½—æ»•',
        text: 'â€œé™†ç‘¶å§ï¼æ±‚æ±‚ä½ ï¼æˆ‘é”™äº†ï¼\næˆ‘è¢«éª—å…‰äº†é’±ï¼Œç°åœ¨é¥­éƒ½åƒä¸ä¸Š...\nçœ‹åœ¨æˆ‘ä»¬ä»¥å‰çš„æƒ…åˆ†ä¸Šï¼Œå€Ÿæˆ‘ç‚¹é’±å§ï¼å°±äº”ç™¾ä¸‡ï¼â€',
        luoteng: 'scared', // è§¦å‘æµæ±—åŠ¨ç”»
        choices: [
            { text: 'ã€å†·é…·ã€‘æ— è§†ä»–ï¼Œç›´æ¥èµ°äºº', next: 'end_cold' },
            { text: 'ã€ç¾è¾±ã€‘è®©ä»–å½“ä¼—å‡ºä¸‘', next: 'humiliate' },
            { text: 'ã€å¥³ç‹ã€‘æ–­ç»ä»–çš„å¿µæƒ³', next: 'end_queen' }
        ]
    },
    'humiliate': {
        name: 'é™†ç‘¶ (æˆ‘)',
        text: 'æˆ‘æ‹¿èµ·éº¦å…‹é£ï¼Œå¯¹ç€å…¨åœºåª’ä½“ï¼š\nâ€œå„ä½ï¼Œè¿™å°±æ˜¯å½“å¹´å·æˆ‘é’±çš„å°å·ã€‚\nç½—æ»•ï¼Œä½ è·ªåœ¨åœ°ä¸Šåƒæ¡è›†è™«çš„æ ·å­ï¼ŒçœŸçš„å¾ˆé…ä½ ã€‚â€',
        luoteng: 'scared',
        choices: [
            { text: 'æ‰”ç»™ä»–ä¸€ç™¾å—ï¼Œè®©ä»–æ»š', next: 'end_money' }
        ]
    },
    // --- ç»“å±€ ---
    'end_cold': {
        name: 'ç»“å±€ Aï¼šå†·é…·æ€»è£',
        text: 'ä½ è¿çœ¼ç¥éƒ½æ²¡ç»™ä»–ä¸€ä¸ªï¼Œè·¨è¿‡ä»–çš„èº«ä½“èµ°è¿›äº†è±ªè½¦ã€‚\nèº«åä¼ æ¥äº†ä¿å®‰æ‹–èµ°ä»–çš„å£°éŸ³ã€‚\nå¯¹äºç°åœ¨çš„ä½ æ¥è¯´ï¼Œä»–åªæ˜¯è·¯è¾¹çš„ä¸€å—åƒåœ¾ã€‚',
        luoteng: 'gone', // æ¶ˆå¤±
        choices: [{text: 'ğŸ” é‡å¯äººç”Ÿ', next: 'intro'}]
    },
    'end_money': {
        name: 'ç»“å±€ Bï¼šæ–½èˆä¸ç¾è¾±',
        text: 'é’ç¥¨é£˜è½åœ¨ä»–çš„èƒ–è„¸ä¸Šã€‚\nä»–å±ˆè¾±åˆè´ªå©ªåœ°æ¡èµ·é’±ã€‚\nâ€œæ‹¿å»ä¹°ä¸ªåŒ…å­å§ï¼Œåˆ«é¥¿æ­»åœ¨æˆ‘å…¬å¸é—¨å£ã€‚â€\nä½ èµ¢äº†ï¼Œèµ¢å¾—å½»å½»åº•åº•ã€‚',
        luoteng: 'scared',
        choices: [{text: 'ğŸ” é‡å¯äººç”Ÿ', next: 'intro'}]
    },
    'end_queen': {
        name: 'ç»“å±€ Cï¼šå¥³ç‹çš„è”‘è§†',
        text: 'â€œç½—æ»•ï¼Œçœ‹çœ‹ç°åœ¨çš„æˆ‘ï¼Œå†çœ‹çœ‹ä½ ã€‚â€\nâ€œæˆ‘ä»¬å·²ç»æ˜¯ä¸¤ä¸ªç‰©ç§äº†ã€‚â€\nä½ ä¼˜é›…åœ°è½¬èº«ï¼Œç•™ç»™ä»–ä¸€ä¸ªæ°¸è¿œæ— æ³•è§¦åŠçš„èƒŒå½±ã€‚',
        luoteng: 'normal',
        choices: [{text: 'ğŸ” é‡å¯äººç”Ÿ', next: 'intro'}]
    }
};

const gameState = {
    luotengStatus: 'normal'
};

// æ‰“å­—æœºæ•ˆæœå‡½æ•°
let typeInterval;
function typeText(text, element, callback) {
    element.innerHTML = '';
    let i = 0;
    clearInterval(typeInterval);
    typeInterval = setInterval(() => {
        element.innerHTML += text.charAt(i);
        if (text.charAt(i) !== ' ' && text.charAt(i) !== '\n') {
            AudioSys.playBlip(); // æ‰“å­—éŸ³æ•ˆ
        }
        i++;
        if (i >= text.length) {
            clearInterval(typeInterval);
            if(callback) callback();
        }
    }, 30); // æ‰“å­—é€Ÿåº¦
}

function loadScene(sceneId) {
    const scene = scenes[sceneId];
    gameState.luotengStatus = scene.luoteng || 'normal';
    
    // æ›´æ–°UI
    const textEl = document.getElementById('text-content');
    const optionsEl = document.getElementById('options-container');
    
    // æ¸…ç©ºé€‰é¡¹ï¼Œç­‰å¾…æ–‡å­—æ‰“å®Œ
    optionsEl.innerHTML = '';

    // æ˜¾ç¤ºåå­—æ ‡ç­¾
    let nameHtml = scene.name ? `<span class="name-tag">${scene.name}</span>` : '';
    
    // å¼€å§‹æ‰“å­—
    // ä¸ºäº†æ–¹ä¾¿ï¼Œåå­—ç›´æ¥æ˜¾ç¤ºï¼Œå†…å®¹æ‰“å­—
    textEl.innerHTML = nameHtml; 
    
    // åˆ›å»ºä¸€ä¸ªæ–°çš„spanæ”¾å†…å®¹
    const contentSpan = document.createElement('span');
    textEl.appendChild(contentSpan);

    typeText(scene.text, contentSpan, () => {
        // æ–‡å­—æ‰“å®Œåæ˜¾ç¤ºé€‰é¡¹
        scene.choices.forEach(choice => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = choice.text;
            btn.onclick = () => loadScene(choice.next);
            optionsEl.appendChild(btn);
        });
    });
}

// ================= åˆå§‹åŒ– =================
document.getElementById('start-btn').addEventListener('click', () => {
    document.getElementById('overlay').style.display = 'none';
    AudioSys.isMuted = false;
    document.getElementById('mute-btn').innerText = "ğŸ”Š å…³é—­éŸ³ä¹";
    AudioSys.playMusic();
    loadScene('intro');
    render(); // å¼€å§‹æ¸²æŸ“ç”»é¢
});

document.getElementById('mute-btn').addEventListener('click', () => {
    AudioSys.toggleMute();
});

// åˆå§‹æ¸²æŸ“ä¸€æ¬¡èƒŒæ™¯ä»¥é˜²é»‘å±
ctx.fillStyle = '#000';
ctx.fillRect(0,0, canvas.width, canvas.height);

</script>
</body>
</html>